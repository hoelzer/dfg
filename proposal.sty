\ProvidesPackage{proposal}[2025/08/03 v3.1.0 DFG Proposal Template]

%==============================================================================
% DFG PROPOSAL STYLE PACKAGE
%==============================================================================
% This package provides formatting and functionality for DFG grant proposals.
% Based on the official DFG guidelines for "Sachbeihilfe" grants.
%
% CONTENTS:
% 1. Basic Configuration (encoding, language, fonts)
% 2. Page Layout and Structure
% 3. Scientific Content Support (math, figures, tables)
% 4. Bibliography and Citation Setup
% 5. Hyperlinks and PDF Properties
% 6. Additional Functionality
% 7. Custom Commands and Environments
%==============================================================================

%==============================================================================
% 1. BASIC CONFIGURATION
%==============================================================================

% --- Encoding and Language ---
\usepackage[utf8]{inputenc}                % Use UTF-8 encoding
\usepackage[ngerman,english]{babel}        % German and English language support

% --- Fonts and Typography ---
\usepackage{helvet}                        % Use Helvetica font
\usepackage{inconsolata}                   % Use Inconsolata font for \texttt{}
\renewcommand{\familydefault}{\sfdefault}  % Set sans-serif as default
\usepackage[final]{microtype}              % Improved typography

%==============================================================================
% 2. PAGE LAYOUT AND STRUCTURE
%==============================================================================

% --- Page Layout ---
% Following DFG margin requirements: https://github.com/hoelzer/dfg/issues/56
\usepackage[headheight=1cm,
  tmargin=2.5cm,
  lmargin=2.5cm,
  rmargin=2cm,
  bmargin=1.5cm]{geometry}       % Page geometry settings

% --- Document Structure ---
\usepackage{scrlayer-scrpage}              % KOMA-Script page style
\KOMAoptions{paper=a4}                     % A4 paper size
\KOMAoption{fontsize}{11pt}                % 11pt base font size

% Suppress informational package notes from 'pageslts'
\let\OldPackageNoteNoLine\PackageNoteNoLine
\renewcommand{\PackageNoteNoLine}[2]{}
\usepackage[pagecontinue=false]{pageslts}  % Page numbering utilities

% --- Headings and Sections ---
\pagestyle{scrheadings}
\setkomafont{section}{\normalsize}         % Section font size
\setkomafont{subsection}{\normalsize}      % Subsection font size
\renewcommand{\headfont}{\sffamily\footnotesize} % Header font
\setlength{\parskip}{0.5em}                % Paragraph spacing
\setlength{\parindent}{0em}                % No paragraph indentation
\ohead*{\pagemark}                         % Page number in outer header
\cfoot*{}                                  % No footer
\chead{}                                   % No center header
\renewcommand{\pagemark}{page \thepage~of \lastpageref{pagesLTS.\pagenumtype}}

% --- Page Numbering ---
\pagenumbering{arabic}                     % Default to arabic numbers
\newcommand{\pagenumtype}{arabic}          % Track page numbering type

% --- Typography Improvements ---
% Avoid widows and orphans
\clubpenalty=10000
\widowpenalty=10000
\displaywidowpenalty=10000

% Reduce underfull hbox warnings
\tolerance=3000
\emergencystretch=15pt
\hbadness=2000
\hyphenpenalty=3000
\doublehyphendemerits=10000

%==============================================================================
% 3. SCIENTIFIC CONTENT SUPPORT
%==============================================================================

% --- Math and Units ---
\usepackage{amsmath}                       % Enhanced math support
\usepackage[exponent-product=\cdot]{siunitx} % SI units with proper formatting
\sisetup{detect-all=true,locale=US}        % SIunitx configuration

% --- Figures and Graphics ---
\usepackage[dvipsnames,svgnames]{xcolor}   % Extended color support
\usepackage{graphicx}                      % Graphics inclusion
\graphicspath{{figures/}}                  % Default path for figures
\usepackage{tikz}                          % TikZ for vector graphics

% --- Tables and Captions ---
\usepackage{longtable}                     % Tables across multiple pages
\usepackage[font=small,
  labelfont={bf,it},
  textfont=it]{caption}          % Caption formatting
\captionsetup{format=plain}                % Simple caption style

%==============================================================================
% 4. BIBLIOGRAPHY AND CITATION SETUP
%==============================================================================

% --- Bibliography Options ---
\newif\ifproposal@fullbib
\proposal@fullbibfalse
\DeclareOption{fullbib}{\proposal@fullbibtrue}
\ProcessOptions\relax

% --- Bibliography Basic Configuration ---
\usepackage[
  sorting=none,
  sortcites=true,
  defernumbers=true,
  doi=false,
  isbn=false,
  url=false,
  citestyle=numeric-comp,
  eprint=true,
  backref=false, % include back references in bibliography
  maxcitenames=2, % affects only the citations in the document body
  maxbibnames=7, % affects only the bibliography, pass 99 to print all
  uniquename=false, % don't add given names to \citeauthor
  giveninits=true,   % (optional) use initials elsewhere instead of full given names    
  hyperref=true,
  block=space,
  backend=biber
]{biblatex}
\renewcommand*{\labelalphaothers}{}

% --- Bibliography Format Customization ---
% Format for bibliography number labels (from dfgproposal.cls)
\DeclareFieldFormat{labelnumberwidth}{\mkbibbrackets{#1}}

% Use smaller font for bibliography
\AtBeginBibliography{\small}

% Define reference context for DFG-specific sections
\DeclareRefcontext{dfg}{labelprefix=A}

% --- DOI/URL/ISBN handling macro ---
% Creates hyperlinks from bibliographic information when available
\newbibmacro{string+doiurlisbn}[1]{%
  \iffieldundef{doi}{%
    \iffieldundef{url}{%
      \iffieldundef{isbn}{%
        \iffieldundef{issn}{%
          #1% No linking information available
        }{%
          \href{http://books.google.com/books?vid=ISSN\thefield{issn}}{#1}%
        }%
      }{%
        \href{http://books.google.com/books?vid=ISBN\thefield{isbn}}{#1}%
      }%
    }{%
      \href{\thefield{url}}{#1}%
    }%
  }{%
    \href{http://dx.doi.org/\thefield{doi}}{#1}%
  }%
}

% --- Title format for different entry types ---
% Apply appropriate formatting to titles and add hyperlinks
\DeclareFieldFormat{title}{%
  \usebibmacro{string+doiurlisbn}{\mkbibemph{#1}}}
\DeclareFieldFormat
[article,inbook,incollection,inproceedings,patent,thesis,unpublished]
{title}{\usebibmacro{string+doiurlisbn}{\mkbibquote{#1\isdot}}}
\DeclareFieldFormat
[suppbook,suppcollection,suppperiodical]
{title}{\usebibmacro{string+doiurlisbn}{#1}}

% --- Bibliography entry simplification ---
% Remove unnecessary fields from bibliography entries unless fullbib option is set
\AtEveryBibitem{%
  \ifproposal@fullbib\else
    % Date fields
    \clearfield{day}%
    \clearfield{month}%
    \clearfield{endday}%
    \clearfield{endmonth}%
    \clearfield{endyear}%
    % Publication details
    \clearfield{issue}%
    \clearfield{number}%
    \clearfield{volume}%
    \clearfield{pubstate}%
    \clearname{editor}%
    \clearfield{eprintclass}%
    \clearfield{eventtitle}%
    \clearlist{location}%
    \clearfield{series}%
    % Special handling for specific entry types
    \ifentrytype{inproceedings}{%
      \clearlist{publisher}%
      \clearfield{pages}%
    }{}%
    \ifentrytype{online}{\iffieldundef{eprint}{}{\clearfield{url}}}{}%
  \fi
}

%==============================================================================
% 5. HYPERLINKS AND PDF PROPERTIES
%==============================================================================

\usepackage[pdftex,
  colorlinks=true,
  linkcolor=MidnightBlue,
  citecolor=MidnightBlue,
  urlcolor=MidnightBlue,
  pdfauthor={},                  % Set author in main document
  pdfpagelayout=SinglePage,
  bookmarks,
  bookmarksopen]{hyperref}       % PDF hyperlinks and metadata

\usepackage[numbered]{bookmark}            % Numbered PDF bookmarks
\usepackage[noabbrev]{cleveref}            % Intelligent cross-referencing

%==============================================================================
% 6. ADDITIONAL FUNCTIONALITY
%==============================================================================

% --- Utilities ---
\usepackage{silence}                       % Suppress specific package info messages
\WarningsOff[pageslts]                     % Mute pageslts informational messages
\usepackage{csquotes}                      % Context-sensitive quotation marks
\usepackage{eurosym}                       % Euro symbol
\usepackage{fp}                            % Fixed-point arithmetic
\usepackage{xspace}                        % Intelligent spacing
\usepackage{verbatim}                      % Verbatim text
\usepackage{ifthen}                        % Conditional processing

%==============================================================================
% 7. CUSTOM COMMANDS AND ENVIRONMENTS
%==============================================================================

% --- Funds Calculation ---
% Environment for calculating and displaying funding totals
\newcommand{\total}{Total}
\newenvironment{funds}[1][]
{\def\funds{0.00} \newcommand{\totaldescr}{#1}}
{\rule{\textwidth}{0.5pt} \par \total~\totaldescr \hfill \num[round-mode=places,round-precision=2]{\funds}\,\euro}

% Add a single funding position
\newcommand{\position}[2]{%
  \par #1 \hfill \num[round-mode=places,round-precision=2]{#2}\,\euro
  \FPeval{\funds}{\funds + #2}%
}

% Add a multiplied funding position (e.g., 3 × 1000€)
\newcommand{\positionmul}[3]{%
  \par #1 \hfill \num{#3} $\times$ \num[round-mode=places,round-precision=2]{#2}\,\euro
  \FPeval{\funds}{\funds + #3*#2}%
}

% --- Document Structure ---
\newcommand{\mainmatter}{%
  \cleardoublepage
  \pagestyle{plain}
}

% Switch to Roman page numbering for appendices
\newcommand{\backmatter}{%
  \clearpage
  \pagenumbering{Roman}
  \renewcommand{\pagenumtype}{Roman}%
  % Only include section, subsection, and paragraph for numbering
  \renewcommand{\theparagraph}{\thesubsubsection.\arabic{paragraph}}%
  \setcounter{secnumdepth}{5}
}

% Create DFG-specific title for project proposals
\newcommand{\makeprojecttitle}{%
  {\raggedright{} \normalsize \bfseries
      Project Description -- Project Proposals \par
      \applicants{} \par
      \project{} \par
      \rule{\textwidth}{0.5pt} \par
    }
}

% Add support for subsubsubsections (paragraph level with heading)
\newcommand{\subsubsubsection}[1]{\paragraph{#1} \mbox{} \par}

% --- Custom Paragraph Styles ---
% Work package style
\newcommand{\workpackagestyle}{%
  \setcounter{secnumdepth}{5}
  \RedeclareSectionCommand[
    beforeskip=-2.5ex plus-1ex minus -.2ex,
    afterskip=2.5ex plus 0.2ex minus 0.2ex]{paragraph}%
  \renewcommand{\theparagraph}{WP\arabic{paragraph}}%
}
\newcommand{\workpackage}[1]{\workpackagestyle\paragraph{#1}\standardstyle}

% Task style
\newcommand{\taskstyle}{%
  \setcounter{secnumdepth}{5}
  \RedeclareSectionCommand[
    indent=0pt, beforeskip=-3.5ex plus-1ex minus -.2ex,
    afterskip=2.5ex plus 0.2ex minus 0.2ex]{subparagraph}
  \renewcommand{\theparagraph}{T\arabic{paragraph}}%
}
\newcommand{\task}[1]{\taskstyle\subparagraph{#1}\standardstyle}

% Standard paragraph style
\newcommand{\standardstyle}{%
  \setcounter{secnumdepth}{4}
  \RedeclareSectionCommand[
    beforeskip=3.25ex plus 1ex minus .2ex,
    afterskip=1.5ex plus .2ex]{paragraph}%
  \renewcommand{\theparagraph}{\thesection.\thesubsection.\thesubsubsection.\arabic{paragraph}}%
}

% Todo list
\usepackage[inline]{enumitem}
\usepackage{amssymb}
\newlist{todolist}{itemize}{2}
\setlist[todolist]{label=$\square$}
\usepackage{pifont}
\newcommand{\done}{\rlap{\raisebox{0.2ex}{\hspace{0.3ex}\scriptsize \ding{56}}}$\square$}

